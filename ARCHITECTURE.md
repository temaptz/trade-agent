# 🏗️ Архитектура торгового бота

## Общая схема системы

```
┌─────────────────────────────────────────────────────────────────┐
│                    ТОРГОВЫЙ БОТ С ИИ АГЕНТОМ                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────────────────────────────────┐ │
│  │   main.py   │───▶│           TradingAgent                  │ │
│  │ Главный файл│    │         (LangGraph Agent)              │ │
│  └─────────────┘    └─────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                LangGraph Workflow                          │ │
│  │                                                             │ │
│  │  analyze_market → analyze_news → make_decision →           │ │
│  │  risk_check → execute_trade → update_position              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │BybitClient  │  │MarketAnalyzer│  │NewsAnalyzer │  │Ollama   │ │
│  │             │  │             │  │             │  │LLM      │ │
│  │• Trading    │  │• Technical  │  │• DuckDuckGo │  │• Gemma2 │ │
│  │• Data       │  │• Indicators │  │• Sentiment  │  │• Local  │ │
│  │• Positions  │  │• Historical │  │• Analysis   │  │• Model  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
│         │                 │                 │                   │
│         ▼                 ▼                 ▼                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │ Bybit API   │  │Alpha Vantage│  │DuckDuckGo   │  │Ollama   │ │
│  │             │  │    API      │  │   Search    │  │Service  │ │
│  │• Real-time  │  │• Historical │  │• News       │  │• Local  │ │
│  │• Trading    │  │• Data       │  │• Search     │  │• LLM    │ │
│  │• Account    │  │• OHLCV      │  │• Results    │  │• API    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                TradingMonitor                              │ │
│  │                                                             │ │
│  │  • Logging        • Performance Metrics                    │ │
│  │  • Health Checks  • Charts & Reports                       │ │
│  │  • Alerts         • Trading History                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Компоненты системы

### 1. TradingAgent (Главный агент)
- **Назначение**: Управление всем процессом торговли
- **Технологии**: LangGraph, LangChain, Ollama
- **Функции**:
  - Координация всех компонентов
  - Принятие торговых решений
  - Управление состоянием системы

### 2. BybitClient (Торговый клиент)
- **Назначение**: Взаимодействие с Bybit API
- **Функции**:
  - Получение рыночных данных
  - Размещение ордеров
  - Управление позициями
  - Получение баланса аккаунта

### 3. MarketAnalyzer (Анализатор рынка)
- **Назначение**: Технический анализ и исторические данные
- **Функции**:
  - Расчет технических индикаторов (RSI, MACD, Bollinger Bands)
  - Анализ трендов и волатильности
  - Поиск уровней поддержки/сопротивления
  - Интеграция с Alpha Vantage API

### 4. NewsAnalyzer (Анализатор новостей)
- **Назначение**: Поиск и анализ новостей
- **Функции**:
  - Поиск новостей через DuckDuckGo
  - Анализ тональности
  - Расчет релевантности
  - Фильтрация по ключевым словам

### 5. TradingMonitor (Мониторинг)
- **Назначение**: Логирование и отслеживание производительности
- **Функции**:
  - Детальное логирование всех операций
  - Расчет метрик производительности
  - Создание отчетов и графиков
  - Мониторинг здоровья системы

## Поток данных

### 1. Анализ рынка
```
Bybit API → MarketAnalyzer → Technical Indicators → TradingAgent
```

### 2. Анализ новостей
```
DuckDuckGo → NewsAnalyzer → Sentiment Analysis → TradingAgent
```

### 3. Принятие решения
```
Market Data + News Data → Ollama LLM → Trading Decision
```

### 4. Выполнение сделки
```
Trading Decision → Risk Check → Bybit API → Order Execution
```

### 5. Мониторинг
```
All Operations → TradingMonitor → Logs & Metrics
```

## LangGraph Workflow

### Узлы графа:
1. **analyze_market** - Анализ технических индикаторов
2. **analyze_news** - Поиск и анализ новостей
3. **make_decision** - Принятие решения с помощью LLM
4. **risk_check** - Проверка рисков
5. **execute_trade** - Выполнение торговой операции
6. **update_position** - Обновление информации о позициях

### Переходы:
- Последовательное выполнение узлов
- Условные переходы на основе результатов
- Обработка ошибок и исключений

## Конфигурация

### Основные параметры (.env):
```env
# API ключи
BYBIT_API_KEY=your_key
BYBIT_SECRET_KEY=your_secret
ALPHA_VANTAGE_API_KEY=your_key

# Торговые параметры
TRADING_SYMBOL=BTCUSDT
MAX_POSITION_SIZE=0.1
RISK_PERCENTAGE=2.0
STOP_LOSS_PERCENTAGE=5.0
TAKE_PROFIT_PERCENTAGE=10.0

# LLM настройки
OLLAMA_MODEL=gemma2:9b
OLLAMA_BASE_URL=http://localhost:11434
```

## Безопасность и надежность

### Защитные механизмы:
- Проверка рисков перед каждой сделкой
- Ограничение частоты торговли
- Защита от серий убытков
- Валидация всех входных данных
- Детальное логирование для аудита

### Мониторинг:
- Health checks системы
- Отслеживание производительности
- Алерты при критических ошибках
- Автоматическое восстановление

## Масштабируемость

### Горизонтальное масштабирование:
- Разделение компонентов на микросервисы
- Использование очередей сообщений
- Балансировка нагрузки

### Вертикальное масштабирование:
- Увеличение ресурсов сервера
- Оптимизация алгоритмов
- Кэширование данных

## Развертывание

### Варианты развертывания:
1. **Локально** - для разработки и тестирования
2. **Docker** - для изолированного развертывания
3. **Сервер** - для продакшена с systemd
4. **Облако** - для высокодоступных систем

### Мониторинг в продакшене:
- Systemd сервисы
- Nginx reverse proxy
- Автоматические бэкапы
- Health checks и алерты